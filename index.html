<script>
    const firebaseConfig = { databaseURL: "https://hotep-f423e-default-rtdb.europe-west1.firebasedatabase.app/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    function updateTotal() {
        const qty = parseInt(document.getElementById('quantity').value) || 1;
        const ship = parseInt(document.getElementById('province').value) || 50;
        document.getElementById('totalDisplay').innerText = (qty * 200) + ship;
    }

    let currentIdx = 0;
    const slider = document.getElementById('mainSlider');
    setInterval(() => {
        currentIdx = (currentIdx + 1) % 2;
        slider.style.transform = `translateX(${currentIdx * 100}%)`;
    }, 4000);

    function submitOrder() {
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        const size = document.getElementById('size').value;
        const qtyValue = document.getElementById('quantity').value;
        const qtyText = document.getElementById('quantity').options[document.getElementById('quantity').selectedIndex].text;
        
        const provElem = document.getElementById('province');
        const provName = provElem.options[provElem.selectedIndex].text.split(' ')[0];
        const shipCost = parseInt(provElem.value);
        const total = (parseInt(qtyValue) * 200) + shipCost;

        if(!name || !/^01[0125][0-9]{8}$/.test(phone) || !address) {
            alert("ูุฑุฌู ุฅุฏุฎุงู ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ (ุงูุงุณูุ ูุฑูู ูุงุชู ุตุญูุญุ ูุงูุนููุงู)");
            return;
        }

        const btn = document.getElementById('orderBtn');
        btn.disabled = true; 
        btn.innerText = "ุฌุงุฑู ุงูุญุฌุฒ...";
        btn.classList.remove('pulse-anim');

        const orderData = {
            ุงูุงุณู: name,
            ุงููุงุชู: phone,
            ุงููุญุงูุธุฉ: provName,
            ุงูุนููุงู: address,
            ุงููููุฉ: qtyValue,
            ุงูููุงุณ: size,
            ุงูุงุฌูุงูู: total,
            ูุตุงุฑูู_ุงูุดุญู: shipCost,
            ุงูุชูููุช: new Date().toLocaleTimeString('ar-EG'),
            ุงูุชุงุฑูุฎ: new Date().toLocaleDateString('ar-EG')
        };

        // 1. ุชุณุฌูู ุงูุฃูุฑุฏุฑ ูู ูุงูุฑุจูุฒ (ููุญุฉ ุงูุฅุฏุงุฑุฉ)
        firebase.database().ref('orders').push(orderData).then(() => {
            
            // 2. ุฅุฑุณุงู ุฑุณุงูุฉ ูุงุชุณุงุจ ุชููุงุฆูุฉ (ุนุจุฑ ุงูุณูุฑูุฑ ุงููุญูู bot.js)
            fetch('http://localhost:3000/send-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    phone: phone,
                    address: address,
                    total: total
                })
            }).catch(err => console.log("ูุงุชุณุงุจ ุบูุฑ ูุชุงุญ ุญุงููุงู"));

            // 3. ุฅุฑุณุงู ุฅุดุนุงุฑ ุชูุฌุฑุงู (ููุง ูุงู ูู ููุฏู)
            const token = "7428109209:AAHswEI-1l8eer80_sobcoaQC2_JEPRJ0EQ";
            const chatId = "7795759414";
            const messageText = `๐ฅ ุฃูุฑุฏุฑ ุฌุฏูุฏ HOTEP\n๐ค ุงูุงุณู: ${name}\n๐ ุงููุงุชู: ${phone}\n๐ ุงูููุงุณ: ${size}\n๐ฆ ุงููููุฉ: ${qtyValue} ุนูุจุฉ\n๐ ุงููุญุงูุธุฉ: ${provName}\n๐ ุงูุนููุงู: ${address}\n๐ ุงูุดุญู: ${shipCost} ุฌ\n๐ฐ ุงูุฅุฌูุงูู: ${total} ุฌ`;
            fetch(`https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(messageText)}`);

            // 4. ุฅุธูุงุฑ ูุงูุฐุฉ ุงููุฌุงุญ ููุนููู
            document.getElementById('confirmDetails').innerHTML = `
                <b>๐ค ุงูุงุณู:</b> ${name}<br>
                <b>๐ ุงูููุงุณ:</b> ${size}<br>
                <b>๐ฆ ุงูุทูุจ:</b> ${qtyText}<br>
                <b>๐ ุงูุดุญู:</b> ${shipCost} ุฌููู<br>
                <b>๐ฐ ุงูุฅุฌูุงูู:</b> ${total} ุฌููู
            `;
            document.getElementById('successModal').style.display = 'flex';

        }).catch((err) => {
            alert("ุญุฏุซ ุฎุทุฃ ูู ุงูุดุจูุฉุ ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู");
            btn.disabled = false;
            btn.innerText = "ุชุฃููุฏ ุงูุทูุจ ุงูุขู";
            btn.classList.add('pulse-anim');
        });
    }
</script>
