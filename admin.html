<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HOTEP Admin</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
:root { --gold: #D4AF37; --black: #050505; --dark: #121212; --green: #2ecc71; --red: #e74c3c; --orange: #f39c12; --purple: #8e44ad; }
body { background: var(--black); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }

/* 1. تنسيق العداد العلوي */
.stats-bar { background: #000; padding: 10px; display: flex; justify-content: space-around; border-bottom: 1px solid #222; }
.stat-item { text-align: center; }
.stat-item span { display: block; color: var(--gold); font-size: 11px; }
.stat-item b { font-size: 18px; color: #fff; }
.reset-btn { text-align: center; color: #666; font-size: 12px; padding: 5px; cursor: pointer; text-decoration: underline; }

.tabs-container { display: flex; background: #111; padding: 5px; margin: 10px; border-radius: 15px; border: 1px solid #333; }
.tab-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #888; cursor: pointer; border-radius: 10px; font-size: 14px; }
.tab-btn.active { background: var(--gold); color: #000; font-weight: bold; }
.tab-content { padding: 0 10px 100px; display: none; }
.tab-content.active { display: block; }

.order-card { background: var(--dark); border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid #222; position: relative; border-right: 4px solid var(--gold); }

/* 3. تعديل مكان عدد العلب ليكون على الشمال */
.qty-tag { background: rgba(212, 175, 55, 0.1); color: var(--gold); padding: 4px 10px; border-radius: 8px; font-size: 12px; position: absolute; left: 15px; top: 50px; border: 1px solid rgba(212, 175, 55, 0.2); }

.order-price { color: var(--green); font-size: 24px; font-weight: bold; text-align: left; }
.name-tag { background: #1a1a1a; color: #fff; padding: 5px 12px; border-radius: 10px; font-size: 18px; font-weight: bold; display: inline-block; margin-top: 5px; }

.action-row { display: flex; gap: 5px; margin-top: 20px; }
.btn-m { flex: 1; height: 40px; border-radius: 8px; border: none; color: #fff; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
.btn-ship { background: var(--purple); flex: 3; }
.btn-done { background: var(--blue); flex: 3; }
.btn-copy { background: var(--orange); }
.btn-wa { background: #25d366; }
.btn-print { background: #fff; color: #000; }
.btn-del { background: var(--red); max-width: 45px; }
</style>
</head>
<body>

<div id="admin-content">
    <div class="stats-bar">
        <div class="stat-item"><span>M</span><b id="sM">0</b></div>
        <div class="stat-item"><span>L</span><b id="sL">0</b></div>
        <div class="stat-item"><span>XL</span><b id="sXL">0</b></div>
        <div class="stat-item"><span>XXL</span><b id="sXXL">0</b></div>
    </div>
    <div class="reset-btn" onclick="resetCounter()">تصفير السجل ↺</div>

    <div class="tabs-container">
        <button class="tab-btn active" onclick="openTab(event, 'new')">جديد</button>
        <button class="tab-btn" onclick="openTab(event, 'shipped')">مشحون</button>
        <button class="tab-btn" onclick="openTab(event, 'done')">مستلم</button>
    </div>

    <div id="new" class="tab-content active"><div id="newList"></div></div>
    <div id="shipped" class="tab-content"><div id="shippedList"></div></div>
    <div id="done" class="tab-content"><div id="doneList"></div></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
let db;
const config = { databaseURL: "https://hotep-f423e-default-rtdb.europe-west1.firebasedatabase.app/" };
if (!firebase.apps.length) firebase.initializeApp(config);
db = firebase.database();

// تحديث العداد من الداتابيز
db.ref('stats_counter').on('value', snap => {
    const d = snap.val() || {M:0, L:0, XL:0, XXL:0};
    document.getElementById('sM').innerText = d.M || 0;
    document.getElementById('sL').innerText = d.L || 0;
    document.getElementById('sXL').innerText = d.XL || 0;
    document.getElementById('sXXL').innerText = d.XXL || 0;
});

db.ref('orders').on('value', snap => {
    let html = { new:'', shipped:'', done:'' };
    snap.forEach(child => {
        const o = child.val();
        const id = child.key;
        const price = (parseInt(o.سعر_المنتج) || 0) + 50;
        const qty = o.الكمية || 1;
        const size = o.المقاس || 'M';

        const card = `
        <div class="order-card">
            <div class="order-price">${price} ج</div>
            <div class="qty-tag">${qty} علبة - ${size}</div>
            <div class="name-tag">${o.الاسم}</div>
            <div style="text-align:right; font-size:13px; color:#aaa; margin-top:10px;">
                ${o.الهاتف}<br>${o.المحافظة} - ${o.العنوان}
            </div>
            <div class="action-row">
                ${o.الحالة === 'مشحون' ? 
                `<button onclick="setStat('${id}','تم التسليم')" class="btn-m btn-done" style="background:#3498db; flex:3;">تم التسليم</button>` : 
                (o.الحالة === 'تم التسليم' ? `<span style="flex:3; text-align:center; color:var(--green);">✅ مستلم</span>` : `<button onclick="shipAndCount('${id}','${size}',${qty})" class="btn-m btn-ship">شحن الأوردر</button>`)
                }
                <button onclick="window.print()" class="btn-m btn-print"><i class="fas fa-print"></i></button>
                <button onclick="window.open('https://wa.me/2${o.الهاتف}')" class="btn-m btn-wa"><i class="fab fa-whatsapp"></i></button>
                <button onclick="copyData('${o.الاسم}','${price}')" class="btn-m btn-copy"><i class="fas fa-copy"></i></button>
                <button onclick="del('${id}')" class="btn-m btn-del">×</button>
            </div>
        </div>`;

        if(o.الحالة === 'تم التسليم') html.done += card;
        else if(o.الحالة === 'مشحون') html.shipped += card;
        else html.new += card;
    });
    document.getElementById('newList').innerHTML = html.new;
    document.getElementById('shippedList').innerHTML = html.shipped;
    document.getElementById('doneList').innerHTML = html.done;
});

// وظيفة الشحن والعد
window.shipAndCount = (id, size, qty) => {
    db.ref('stats_counter/' + size).transaction(c => (c || 0) + parseInt(qty));
    db.ref('orders/' + id).update({ الحالة: 'مشحون' });
};

// وظيفة التصفير
window.resetCounter = () => {
    if(confirm('تصفير سجل المقاسات؟')) db.ref('stats_counter').set({M:0, L:0, XL:0, XXL:0});
};

window.openTab = (evt, name) => {
    let contents = document.getElementsByClassName("tab-content");
    for (let i = 0; i < contents.length; i++) contents[i].style.display = "none";
    let buttons = document.getElementsByClassName("tab-btn");
    for (let i = 0; i < buttons.length; i++) buttons[i].classList.remove("active");
    document.getElementById(name).style.display = "block";
    evt.currentTarget.classList.add("active");
};

window.setStat = (id, s) => db.ref('orders/'+id).update({ الحالة: s });
window.del = (id) => { if(confirm('حذف؟')) db.ref('orders/'+id).remove(); };
window.copyData = (n, p) => { navigator.clipboard.writeText(`${n}\n${p}ج`).then(() => alert("تم النسخ")); };
</script>
</body>
</html>

